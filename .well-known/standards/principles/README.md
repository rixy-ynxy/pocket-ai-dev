# 開発ガイド

## AIエージェントとの対話手順

### 1. 効果的なAI利用のための原則

#### コード変更時の原則
- 削除を含む更新は明示的に確認を取る
- 既存コードの変更は最小限に抑える
- コメントは "// ... existing code ..." で省略を表現
- 変更箇所は前後の文脈を含めて提示

#### ファイル操作の原則
- 新規ファイル作成時は完全な内容を記述
- ファイルパスは必ず明示（例: ```language:path/to/file）
- 言語指定は必須（例: ```typescript）
- 複数ファイルの変更は個別に指示

#### レビュー依頼時の原則
- 関連する設計原則を明示
- 特に注目して欲しい観点を指定
- 既存の実装パターンとの整合性を確認
- パフォーマンスへの影響を考慮

#### エラー処理の原則
- エラーパターンの明確な定義
- 適切なエラーメッセージの提供
- エラーの伝播経路の明示
- 回復手順の提示

#### テストコードの原則
- テストの意図を明確に記述
- 境界値のテストを含める
- モックの使用は最小限に
- テストデータは現実的な値を使用

#### ドキュメント更新の原則
- 変更の理由を明記
- 影響範囲を明示
- 使用例の提供
- 注意事項の記載

#### 設計提案時の原則
- スケーラビリティを考慮
- セキュリティ要件の確認
- 保守性への配慮
- 既存システムとの整合性

### 2. AIとの対話例

#### 良い例
```
以下のファイルの更新をお願いします：

対象: src/features/user/UserProfile.tsx
目的: ユーザープロフィールの更新機能の追加
制約:
- 既存のフォームコンポーネントを使用
- バリデーションは共通ライブラリを使用
- エラーハンドリングは既存パターンに従う
```

#### 避けるべき例
```
コードを修正してください
ユーザー機能を改善したい
全体的に見直して
```

### 3. 設定ファイルとの連携

- `.cursorrules`: カーソルの動作とコード生成の規則
- `settings.json`: プロジェクト固有の設定と規約
- `ai-principles.json`: AI動作の制御と原則

これらの設定ファイルを参照することで、より一貫性のある開発が可能になります。

### 4. 基本的な指示方法

#### コード変更の依頼
```
以下の変更をお願いします：
- 変更内容の説明
- 影響するファイルパス
- 期待する動作
```

#### レビューの依頼
```
以下のコードをレビューしてください：
```codeblock
(コード)
```
```

#### 設計相談
```
以下の要件に対する設計案を提案してください：
- 機能要件
- 非機能要件
- 制約条件
```

### 5. 指示時の注意点

- **具体的な文脈の提供**
  - 関連するファイルパスを明示
  - 変更の目的を説明
  - 制約条件があれば明記

- **期待する出力形式の指定**
  - コード変更: 差分形式
  - 設計提案: 構造化された形式
  - レビュー: 項目別のコメント

- **フィードバックの方法**
  - 提案内容が不明確な場合は質問する
  - 部分的な採用の場合はその旨を伝える
  - 代替案の提示を求める場合は条件を明確に

### 6. 品質管理のポイント

- **レビュー基準**
  - 設計原則との整合性
  - コーディング規約の遵守
  - テストカバレッジの確保
  - パフォーマンスへの影響

- **受け入れ条件**
  - 自動テストの通過
  - コードレビューの承認
  - ドキュメントの更新
  - 変更履歴の記録

### 7. トラブルシューティング

- **一般的な問題と解決策**
  - AIの提案が不適切な場合: より具体的な制約を提示
  - 実装が複雑すぎる場合: 段階的な実装を依頼
  - パフォーマンスの問題: 具体的な要件を明示

- **エスカレーションのタイミング**
  - 複数回の修正で解決しない場合
  - 設計上の重要な判断が必要な場合
  - セキュリティに関わる変更の場合

## その他の開発ガイド

### 0. AIエージェントの基本的な理解

#### AIエージェントとは
- コードの理解と生成が可能なAIアシスタント
- 設計原則やパターンに基づいて提案を行う
- 人間の指示に従って作業を支援

#### AIエージェントの特徴
- 文脈を理解して適切な提案が可能
- 一貫性のある実装を提供
- 既存コードを参照して提案を行う

#### AIエージェントの限界
- 完璧な理解は期待できない
- 文脈の誤解が発生することがある
- 新しい概念の理解には説明が必要

例）新しいライブラリの使用方法を説明する場合：
```
このプロジェクトでは@tanstack/react-queryを使用します。
以下のパターンに従って実装してください：

1. カスタムフックの形式
```typescript:src/hooks/useUsers.ts
export const useUsers = () => {
  return useQuery({
    queryKey: ['users'],
    queryFn: fetchUsers
  })
}
```

2. エラーハンドリング
```typescript
if (error) {
  return <ErrorComponent message={error.message} />
}
```
```

#### よくある失敗パターン
- 曖昧な指示による誤った実装
- 文脈不足による不適切な提案
- 制約条件の見落とし

例）悪い指示：
```
ユーザー一覧を実装してください
```

良い指示：
```
src/features/users/UserList.tsxにユーザー一覧を実装してください：

要件：
- useUsers フックを使用
- ローディング状態の表示
- エラーハンドリング
- ページネーション（10件/ページ）
- ユーザーカードコンポーネントの再利用

参考実装：src/features/products/ProductList.tsx
```

#### 効率化のコツ
- テンプレートの活用
- 段階的な指示の組み立て
- フィードバックの効果的な与え方

例）段階的な指示：
```
1. まずインターフェースを定義してください
2. 次にカスタムフックを実装してください
3. 最後にUIコンポーネントを実装してください

各ステップで確認を行い、必要に応じて修正します。
```

#### 高度な利用パターン
- 複数のAIエージェントの使い分け
- プロンプトエンジニアリングの応用
- カスタムルールの作成と適用

例）複数エージェントの使い分け：
```
1. コード生成用エージェント
- 新規機能の実装
- ボイラープレートコードの生成

2. レビュー用エージェント
- コードレビュー
- パフォーマンス分析
- セキュリティチェック

3. テスト用エージェント
- テストケースの生成
- テストデータの作成
- カバレッジ分析
```

#### パフォーマンス最適化
- 文脈提供の最適化
- 指示の構造化と再利用
- フィードバックループの確立

例）文脈提供の最適化：
```
# コンテキスト
- 機能: ユーザー認証
- 関連ファイル: 
  - src/features/auth/
  - src/hooks/useAuth.ts
  - src/types/auth.ts

# 実装要件
- JWT認証
- リフレッシュトークン
- 永続化（localStorage）

# 制約
- zod によるバリデーション
- React Query の使用
- エラーハンドリング規約の遵守
```

#### 品質管理の高度化
- 自動レビュー基準の設定
- 静的解析との連携
- CI/CDパイプラインへの組み込み

#### 用語解説
- ボイラープレート: 定型的なコードの雛形
- プロンプトエンジニアリング: AIへの効果的な指示の設計
- CI/CD: 継続的な開発・デプロイの自動化
- 静的解析: コードの実行前チェック

#### 必要な前提知識
- Git/GitHubの基本操作
- TypeScript/Reactの基礎
- APIの基本概念
- テストの基本的な考え方

#### AIエージェント活用の学習ステップ
1. 基本（1-2週間）
   - 基本的なコード生成依頼
   - エラーメッセージの理解
   - 簡単なバグ修正依頼

2. 実践（2-4週間）
   - コンポーネントの実装依頼
   - テストコードの生成
   - リファクタリングの提案

3. 応用（1-2ヶ月）
   - 設計提案の依頼
   - パフォーマンス最適化
   - セキュリティレビュー

#### 困ったときは
- チームのシニアメンバーに相談
- コードレビューで学習
- 公式ドキュメントの参照
- 段階的に質問を組み立てる

#### AIエージェントの基本操作
- 会話の開始方法
  ```
  新しいチャットを開始
  または
  既存のチャットを継続
  ```

- コードの共有方法
  ```
  1. ファイル全体を共有
  2. 特定の部分を共有（前後の文脈を含める）
  3. 複数ファイルの関連部分を共有
  ```

- エラー時の情報共有
  ```
  1. エラーメッセージ全文
  2. エラーが発生した文脈
  3. 試したこと
  ```

#### プロジェクト固有のガイドライン

- アーキテクチャ規約
  ```
  - Clean Architecture の採用
  - 機能ごとのディレクトリ構造
  - ドメイン駆動設計の適用
  ```

- コーディング規約
  ```
  - ESLint/Prettier の設定に従う
  - コンポーネントの命名規則
  - 状態管理の方針
  ```

- テスト規約
  ```
  - テストファイルの配置
  - テストの粒度
  - カバレッジ要件
  ```

- ドキュメント規約
  ```
  - JSDoc の使用
  - README の更新
  - 変更履歴の記録
  ```
# 開発者向け手順書

## 環境セットアップ

### フロントエンド（Next.js）

```bash
cd frontend
npm install
npm run dev  # http://localhost:3000 で起動
```

### バックエンド（FastAPI）

```bash
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload  # http://localhost:8000 で起動
```

## テスト実行

### 1. ユニットテスト

#### フロントエンドテスト

```bash
cd frontend
npm run test
```

ウォッチモード（開発用）：
```bash
npm run test:watch
```

#### バックエンドテスト

```bash
cd backend
source venv/bin/activate
python -m pytest
```

### 2. E2Eテスト

E2Eテストは、フロントエンドとバックエンドの単体テストが成功した後に実行してください。

前提条件：
- フロントエンドの単体テストが成功していること
- バックエンドの単体テストが成功していること

実行手順：
```bash
cd e2e
npm run test
```

デバッグモードでの実行：
```bash
DEBUG=pw:webserver npm run test
```

### E2Eテスト（Playwright）

```bash
cd e2e
npm install
npx playwright install  # ブラウザのインストール
npm run test  # テストの実行
npm run test:ui  # UIモードでテストを実行
npm run report  # テスト結果レポートの表示
DEBUG=pw:webserver npm run test

```

### バックエンドテスト（Pytest）

```bash
cd backend
source venv/bin/activate
pytest  # 全テストの実行
pytest tests/test_file.py  # 特定のテストファイルを実行
pytest -v  # 詳細なテスト結果を表示
```

## 開発

### フロントエンド開発

```bash
cd frontend
npm run dev
```

### バックエンド開発

```bash
cd backend
source venv/bin/activate
uvicorn main:app --reload
```

## データベース操作

```bash
cd backend
# マイグレーションの作成
alembic revision --autogenerate -m "変更の説明"

# マイグレーションの適用
alembic upgrade head

# マイグレーションの巻き戻し
alembic downgrade -1
```

## 開発用コマンド

### コードフォーマット

```bash
# フロントエンド
cd frontend
npm run lint
npm run format

# バックエンド
cd backend
black .
isort .
```

### 型チェック

```bash
# フロントエンド
cd frontend
npm run type-check

# バックエンド
cd backend
mypy .
```

## トラブルシューティング

### E2Eテストのデバッグ

```bash
# デバッグモードでテスト実行
DEBUG=pw:api npm run test

# 特定のテストファイルのみ実行
npm run test tests/document-upload.spec.ts

# UIモードで特定のテストを実行
npm run test:ui tests/document-upload.spec.ts
```

### サーバーのデバッグ

```bash
# バックエンドのデバッグモード
uvicorn main:app --reload --log-level debug

# フロントエンドのデバッグモード
NODE_ENV=development npm run dev
```

### キャッシュのクリア

```bash
# フロントエンド
cd frontend
rm -rf .next
npm run dev

# バックエンド
cd backend
rm -rf __pycache__
rm -rf .pytest_cache
```

## デプロイ

```bash
# フロントエンドのビルド
cd frontend
npm run build

# バックエンドのビルド
cd backend
docker build -t arthea-backend .
```

## その他の便利なコマンド

```bash
# 依存関係の更新
cd frontend
npm update

cd backend
pip install --upgrade -r requirements.txt

# 開発サーバーの再起動
cd frontend
npm run dev

cd backend
uvicorn main:app --reload
```